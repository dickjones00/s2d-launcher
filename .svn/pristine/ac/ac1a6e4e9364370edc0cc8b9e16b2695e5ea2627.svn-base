using System;
using System.ComponentModel;
using System.Configuration;
using System.Data;
using System.Diagnostics;
using System.Drawing;
using System.Media;
using System.Net;
using System.Reflection;
using System.Windows.Forms;
using Launcher.Models;
using System.Collections.Generic;
using System.Text.RegularExpressions;
using System.Collections.Specialized;

namespace Launcher
{
    public partial class fmLauncher : Form
    {
        public fmLauncher()
        {
            InitializeComponent();
            SetInitialValues(); // postavlja definirane vrijednosti stupaca u grdLaunch
        }

        public void fmLauncher_Load(object sender, EventArgs e)
        {
            cboApps.SelectedIndex = 0; // 0 = S2D - default izabrana vrijednost sa popisa

            string s = null;
            s = Assembly.GetExecutingAssembly().GetName().Version.ToString();
            this.Text = "S2D/DQM Launcher v" + s; //broj verzije u title bar
            //treba dovrsiti stavljanje verzije(revizije) u title bar

            //ubacivanje vrijednosti u tablicu iz SvcSettings klase
            List<SvcSettings> list = SvcSettings.GetSettingsFromConfig();
            this.grdLaunch.DataSource = list;
            this.ActiveControl = cboApps;
            grdLaunch.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        }

        void SetInitialValues()
        {
            grdLaunch.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill;
            DataGridViewButtonColumn btn = new DataGridViewButtonColumn();
            grdLaunch.Columns.Add(btn);
            btn.HeaderText = "Pokreni";
            btn.Text = "Pokreni";
            btn.Name = "btn";
            btn.UseColumnTextForButtonValue = true;
            btn.MinimumWidth = 60;
        }

        private void btnAddListEntry_Click(object sender, EventArgs e)
        {
            string devAction = "-";
            string devSession = "-";
            //string url = txtHttp.Text + txtUrl.Text + semiColon + txtPort.Text;
            #region CheckboxNames
            bool debug = false;
            if (chkAction.Checked)
            {
                if (txtAction.Text == "")
                {
                    MessageBox.Show("Ako je izabrana developer opcija 'action', polje za unos opcije ne smije biti prazno!");
                    goto DoNothingAction;
                }
                else
                {
                    devAction = txtAction.Text;
                }
            }

            if (chkSession.Checked)
            {
                if (txtSession.Text == "")
                {
                    MessageBox.Show("Ako je izabrana developer opcija 'session', polje za unos opcije ne smije biti prazno!");
                    goto DoNothingSession;
                }
                else
                {
                    devSession = txtSession.Text;
                }
            }

            if (chkDebug.Checked)
            {
                debug = true;
            }
            #endregion

            // nm: inace, string moze biti i null pa se to provjerava ovako: if (!string.IsNullOrEmpty(txtName.Text)) - ali u TextBox kontroli nikad nece biti null pa je ovo tvoje ok
            if (txtName.Text != "" && cboApps.Text != "" && txtHttp.Text != "" && txtUsername.Text != "" && txtPassword.Text != "")
            {

                var section = ConfigurationManager.GetSection("appSettings") as NameValueCollection;
                var value = section[txtName.Text];
                string[] words = { "|", "|" };
                if (value != null)
                {
                    words = value.Split('|');
                }

                if (words[0] == txtName.Text)
                {
                    MessageBox.Show("Unos s istim imenom već postoji!\n\nUnesite novo ime.", "Upozorenje", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    this.ActiveControl = txtName;
                }
                else
                {
                    AppName.appNameCombo = txtName.Text;
                    SaveList.addDataToAppconfig(txtName.Text + "|"
                                               + cboApps.Text + "|"
                                               + txtHttp.Text + txtUrl.Text + "|"
                                               + txtPort.Text + "|"
                                               + txtUsername.Text + "|"
                                               + txtPassword.Text + "|"
                                               + debug.ToString() + "|"
                                               + devAction + "|"
                                               + devSession);
                    List<SvcSettings> list = SvcSettings.GetSettingsFromConfig();
                    this.grdLaunch.DataSource = list;
                }
            }
            else
            {
                MessageBox.Show("Svi obavezni podaci (ime, endpoint(URL), username, password) moraju biti uneseni!", "Greška", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            grdLaunch.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        DoNothingAction: ;
        DoNothingSession: ;

        }

        public class AppName // pozivanje txt controli u druge clase npr. fmLauncher.AppName.appNameCombo
        // pa ovdje dodati po potrebi variable i dodati im vrijednost
        {
            public static string appNameCombo = string.Empty;

        }
        private void btnDeleteListEntry_Click(object sender, EventArgs e)
        {
            string deleteEntry = "";
            if (grdLaunch.RowCount > 0)
            {
                deleteEntry = grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[0].Value.ToString();
                var delEntryFromConfig = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);
                delEntryFromConfig.AppSettings.Settings.Remove(deleteEntry);
                delEntryFromConfig.Save(ConfigurationSaveMode.Modified);
                ConfigurationManager.RefreshSection("appSettings"); // refresh appSettings sekciju pa se i gridview refresha
                List<SvcSettings> list = SvcSettings.GetSettingsFromConfig();
                this.grdLaunch.DataSource = list;
            }
        }

        private void txtPort_KeyPress(object sender, KeyPressEventArgs e)
        {
            if (!char.IsControl(e.KeyChar)// samo brojevi u PORT polje
                && !char.IsDigit(e.KeyChar))
            {
                e.Handled = true;
                MessageBox.Show("Dopušteni su samo brojevi!");
            }
        }

        public bool IsAddressValid(string addrString) // nm: dobra fora :))
        {
            IPAddress address;
            return IPAddress.TryParse(addrString, out address); // provjerava ispravnost upisane IP adrese
        }

        private void txtUrl_Leave(object sender, EventArgs e)
        {
            if (IsAddressValid(txtUrl.Text) == false)
            {
                MessageBox.Show("Provjerite ispravnost IP adrese!", "Obavijest!", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private void btnExit_Click(object sender, EventArgs e)
        {
            Application.Exit();
        }

        private void fmLauncher_FormClosing(object sender, FormClosingEventArgs e)
        {
            #region radi snimanje u XML ali ne treba
            //DataTable table = new DataTable("LauncherCommandLineInfo");
            //// copy the correct structure from datagridview to the table
            //foreach (DataGridViewColumn column in grdLaunch.Columns)
            //{
            //    table.Columns.Add(column.Name, typeof(string)); //ako je prazno ime onda se rushi
            //}

            //// populate the datatable from datagridview
            //for (int rowIndex = 0; rowIndex < grdLaunch.Rows.Count; rowIndex++)
            //{
            //    DataRow newRow = table.Rows.Add();
            //    for (int columnIndex = 0; columnIndex < grdLaunch.Columns.Count; columnIndex++)
            //    {
            //        try
            //        {
            //            newRow[columnIndex] = grdLaunch.Rows[rowIndex].Cells[columnIndex].Value;
            //        }
            //        catch (Exception ex)
            //        {
            //            MessageBox.Show(ex.Message);
            //        }
            //    }
            //}
            //DataSet ds = new DataSet();
            //ds.Tables.Add(table);
            //ds.WriteXml("Launcher.Config.xml", System.Data.XmlWriteMode.IgnoreSchema);
            #endregion
            //treba doraditi snimanje kod zatvaranja. trenutno stavlja dupli zapis u isti red
            //mozda maknuti ovo sve i staviti provjeru da li je file izmjenje pa pitanje da se spreme izmjene

        }

        private void grdLaunch_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            try
            {
                txtName.Text = grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[0].Value.ToString();
                cboApps.Text = grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[1].Value.ToString();
                System.Uri uri = new Uri(grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[2].Value.ToString());
                string uriWithoutScheme = uri.Host + uri.PathAndQuery;
                uriWithoutScheme = uriWithoutScheme.TrimEnd('/');
                txtUrl.Text = uriWithoutScheme;
                txtPort.Text = grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[3].Value.ToString();
                txtUsername.Text = grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[4].Value.ToString();
                txtPassword.Text = grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[5].Value.ToString();
                Boolean i = bool.Parse(grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[6].Value.ToString());
                if (i == true)
                {
                    chkDebug.Checked = true;
                }
                else
                {
                    chkDebug.Checked = false;
                }
                if (e.ColumnIndex == grdLaunch.ColumnCount-1) // pokrece se s2d_v2.exe sa parametrima
                {
                    string semiColon = "";
                    string opcAktion = "";
                    string opcSession = "";
                    string opcDebug = "";
                    if(i==true)
                    {
                        opcDebug = " -debug true ";
                    }
                    if (grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[3].Value.ToString() != "")
                    {
                        semiColon = ":";
                    }
                    if (grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[7].Value.ToString() != "-")
                    {
                        opcAktion = " -action " + grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[7].Value.ToString();
                    }
                    if (grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[8].Value.ToString() != "-")
                    {
                        opcSession = " -session " + grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[8].Value.ToString();
                    }                    
                    string urlFull = grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[2].Value.ToString() + semiColon + grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[3].Value.ToString();
                    ProcessStartInfo startInfo = new ProcessStartInfo();
                    startInfo.FileName = grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[1].Value.ToString() + ".exe";
                    startInfo.Arguments = " -endpoint " + urlFull
                                        + " -user " + grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[4].Value.ToString()
                                        + " -pass " + grdLaunch.Rows[grdLaunch.CurrentCell.RowIndex].Cells[5].Value.ToString()
                                        + opcDebug + opcAktion + opcSession;
                    //Process.Start(startInfo);
                    MessageBox.Show(startInfo.FileName.ToString() + startInfo.Arguments.ToString());
                }
            }
            catch (Exception ex)
            {

                MessageBox.Show("Greška pri pokretanju aplikacije:" + "\n\n" + ex.Message.ToString(), "Greška", MessageBoxButtons.OK, MessageBoxIcon.Error);

            }
        }

        private void txtName_KeyDown(object sender, KeyEventArgs e)
        {
            Keys key = e.KeyCode;
            if (key == Keys.Space)
            {
                e.Handled = true;
            }

            base.OnKeyDown(e);

        }

        private void txtName_Leave(object sender, EventArgs e)
        {
            if (txtName.Text.Contains(" "))
            {
                MessageBox.Show("Ime ne smije sadržavati prazna mjesta (koristite underscore '_').");
                this.ActiveControl = txtName;
                String sel = txtName.SelectedText;
                //txtName.Focus();
            }
        }

        private void chkAction_CheckedChanged(object sender, EventArgs e)
        {
            if (chkAction.Checked == true)
            {
                txtAction.ReadOnly = false;
            }
            else
            {
                txtAction.ReadOnly = true;
            }
        }

        private void chkSession_CheckedChanged(object sender, EventArgs e)
        {
            if (chkSession.Checked == true)
            {
                txtSession.ReadOnly = false;
            }
            else
            {
                txtSession.ReadOnly = true;
            }
        }

    }
}